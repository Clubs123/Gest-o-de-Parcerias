<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gest√£o de Parcerias - Online</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    // ‚úÖ CREDENCIAIS CONFIGURADAS
    const firebaseConfig = {
      apiKey: "AIzaSyAiP81VznPf_6CBUiXbC_Fes_tXzQyIPV8",
      authDomain: "gest-5fa93.firebaseapp.com",
      projectId: "gest-5fa93",
      storageBucket: "gest-5fa93.firebasestorage.app",
      messagingSenderId: "302922275805",
      appId: "1:302922275805:web:5cb248241c1e8a7e407434",
      measurementId: "G-G1PEK55PGY"
    };

    // Inicializar Firebase
    let db;
    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
      db = firebase.firestore();
    } catch (error) {
      console.error("Erro ao inicializar Firebase:", error);
    }

    const App = () => {
      const [linhas, setLinhas] = useState([]);
      const [editando, setEditando] = useState(null);
      const [temp, setTemp] = useState(null);
      const [busca, setBusca] = useState('');
      const [filtroStatus, setFiltroStatus] = useState('todos');
      const [filtroEstado, setFiltroEstado] = useState('todos');
      const [filtroValidade, setFiltroValidade] = useState('todos');
      const [ordenarAlfabetico, setOrdenarAlfabetico] = useState(false);
      const [carregando, setCarregando] = useState(true);
      const [erro, setErro] = useState(null);

      const estados = ['Nacional', 'AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'];

      // Carregar dados do Firebase em tempo real
      useEffect(() => {
        if (!db) {
          setErro("Firebase n√£o configurado. Configure as credenciais no c√≥digo.");
          setCarregando(false);
          return;
        }

        const unsubscribe = db.collection('parcerias').onSnapshot(
          (snapshot) => {
            const dados = [];
            snapshot.forEach((doc) => {
              dados.push({ id: doc.id, ...doc.data() });
            });
            setLinhas(dados);
            setCarregando(false);
            setErro(null);
          },
          (error) => {
            console.error("Erro ao carregar dados:", error);
            setErro("Erro ao conectar com Firebase. Verifique as credenciais.");
            setCarregando(false);
          }
        );

        return () => unsubscribe();
      }, []);

      const statusCores = {
        'Pendente de An√°lise': 'bg-amber-100 text-amber-800 border-amber-400',
        'Aprovado para Renova√ß√£o': 'bg-emerald-100 text-emerald-800 border-emerald-500',
        'N√£o Renovar': 'bg-rose-100 text-rose-800 border-rose-500',
        'Aguardando Inser√ß√£o': 'bg-sky-100 text-sky-800 border-sky-500',
        'Inserido na Plataforma': 'bg-teal-100 text-teal-800 border-teal-500',
        'Em Negocia√ß√£o': 'bg-violet-100 text-violet-800 border-violet-500',
        'Cancelado': 'bg-slate-100 text-slate-800 border-slate-500',
        'Pausado': 'bg-orange-100 text-orange-800 border-orange-500'
      };

      const statusEmoji = {
        'Pendente de An√°lise': '‚è≥',
        'Aprovado para Renova√ß√£o': '‚úÖ',
        'N√£o Renovar': '‚ùå',
        'Aguardando Inser√ß√£o': '‚è∞',
        'Inserido na Plataforma': 'üéØ',
        'Em Negocia√ß√£o': 'ü§ù',
        'Cancelado': '‚õî',
        'Pausado': '‚è∏Ô∏è'
      };

      const calcDias = (data) => {
        if (!data) return null;
        const hoje = new Date();
        hoje.setHours(0,0,0,0);
        const val = new Date(data + 'T00:00:00');
        return Math.ceil((val - hoje) / 86400000);
      };

      const formatarData = (data) => {
        if (!data) return '-';
        const [ano, mes, dia] = data.split('-');
        return `${dia}/${mes}/${ano}`;
      };

      const adicionar = async () => {
        const nova = {
          escola: '',
          estados: [],
          status: 'Pendente de An√°lise',
          dataContato: '',
          dataRenovacao: '',
          dataInsercao: '',
          dataValidade: '',
          validadeIndeterminada: false,
          responsavel: '',
          contatoResponsavel: '',
          emailResponsavel: '',
          linkContrato: '',
          observacoes: '',
          ativo: true,
          criadoEm: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        try {
          const docRef = await db.collection('parcerias').add(nova);
          setEditando(docRef.id);
          setTemp({...nova, id: docRef.id});
        } catch (error) {
          alert('Erro ao adicionar: ' + error.message);
        }
      };

      const salvar = async () => {
        if (!temp) return;
        try {
          const { id, criadoEm, ...dados } = temp;
          await db.collection('parcerias').doc(id).update(dados);
          setEditando(null);
          setTemp(null);
        } catch (error) {
          alert('Erro ao salvar: ' + error.message);
        }
      };

      const excluir = async (id) => {
        if (!confirm('Excluir?')) return;
        try {
          await db.collection('parcerias').doc(id).delete();
        } catch (error) {
          alert('Erro ao excluir: ' + error.message);
        }
      };

      const alternarAtivo = async (id, ativo) => {
        try {
          await db.collection('parcerias').doc(id).update({ ativo: !ativo });
        } catch (error) {
          alert('Erro ao atualizar: ' + error.message);
        }
      };

      const iniciarEdicao = (linha) => {
        setEditando(linha.id);
        setTemp({...linha, estados: [...(linha.estados || [])]});
      };

      const cancelarEdicao = () => {
        setEditando(null);
        setTemp(null);
      };

      const exportar = () => {
        const headers = 'Ativo,Escola,Estados,Status,Data Prospec√ß√£o,Data Renova√ß√£o,Data Inser√ß√£o,Validade,Respons√°vel,Contato,Email,Contrato,Observa√ß√µes\n';
        const csv = linhas.map(l => 
          `"${l.ativo?'Sim':'N√£o'}","${l.escola}","${(l.estados||[]).join('; ')}","${l.status}","${formatarData(l.dataContato)}","${formatarData(l.dataRenovacao)}","${formatarData(l.dataInsercao)}","${l.validadeIndeterminada?'Indeterminada':formatarData(l.dataValidade)}","${l.responsavel}","${l.contatoResponsavel}","${l.emailResponsavel}","${l.linkContrato}","${l.observacoes}"`
        ).join('\n');
        const blob = new Blob(['\uFEFF' + headers + csv], {type: 'text/csv;charset=utf-8;'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `parcerias_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
      };

      const filtradas = linhas.filter(l => {
        const ok1 = !busca || (l.escola||'').toLowerCase().includes(busca.toLowerCase()) || (l.responsavel||'').toLowerCase().includes(busca.toLowerCase());
        const ok2 = filtroStatus === 'todos' || l.status === filtroStatus;
        const ok3 = filtroEstado === 'todos' || (l.estados||[]).includes(filtroEstado);
        let ok4 = true;
        if (filtroValidade !== 'todos') {
          if (filtroValidade === 'indeterminada') ok4 = l.validadeIndeterminada;
          else if (filtroValidade === 'vencidas') {
            const d = calcDias(l.dataValidade);
            ok4 = !l.validadeIndeterminada && d !== null && d < 0;
          } else if (filtroValidade === 'proximo_30') {
            const d = calcDias(l.dataValidade);
            ok4 = !l.validadeIndeterminada && d !== null && d >= 0 && d <= 30;
          } else if (filtroValidade === 'proximo_60') {
            const d = calcDias(l.dataValidade);
            ok4 = !l.validadeIndeterminada && d !== null && d >= 31 && d <= 60;
          } else if (filtroValidade === 'acima_60') {
            const d = calcDias(l.dataValidade);
            ok4 = !l.validadeIndeterminada && d !== null && d > 60;
          }
        }
        return ok1 && ok2 && ok3 && ok4;
      });

      const linhasExibicao = ordenarAlfabetico 
        ? [...filtradas].sort((a, b) => (a.escola || '').localeCompare(b.escola || ''))
        : filtradas;

      const stats = {
        total: linhas.length,
        ativos: linhas.filter(l => l.ativo).length,
        vencidas: linhas.filter(l => !l.validadeIndeterminada && l.dataValidade && calcDias(l.dataValidade) < 0).length,
        proximo: linhas.filter(l => !l.validadeIndeterminada && l.dataValidade && calcDias(l.dataValidade) >= 0 && calcDias(l.dataValidade) <= 30).length
      };

      if (erro) {
        return (
          <div className="min-h-screen bg-red-50 p-4 flex items-center justify-center">
            <div className="bg-white rounded-lg shadow-lg p-8 max-w-2xl">
              <h1 className="text-2xl font-bold text-red-600 mb-4">‚ö†Ô∏è Erro de Configura√ß√£o</h1>
              <p className="text-gray-700 mb-4">{erro}</p>
              <div className="bg-yellow-50 border border-yellow-200 rounded p-4">
                <p className="font-semibold mb-2">üìù Para configurar o Firebase:</p>
                <ol className="list-decimal list-inside space-y-1 text-sm text-gray-600">
                  <li>Acesse console.firebase.google.com</li>
                  <li>Crie um novo projeto</li>
                  <li>V√° em Configura√ß√µes do Projeto</li>
                  <li>Copie as credenciais</li>
                  <li>Cole no c√≥digo HTML (linha 17-23)</li>
                </ol>
              </div>
            </div>
          </div>
        );
      }

      if (carregando) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
              <p className="text-gray-600">Carregando dados...</p>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 p-4">
          <div className="max-w-full mx-auto">
            <div className="bg-white rounded-lg shadow p-6 mb-4">
              <div className="flex justify-between items-center mb-4">
                <div>
                  <h1 className="text-2xl font-bold">üìä Gest√£o de Parcerias</h1>
                  <p className="text-sm text-gray-600">{linhas.length} escolas ‚Ä¢ <span className="text-green-600 font-semibold">üîÑ Sincronizado Online</span></p>
                </div>
                <div className="flex gap-2">
                  <button onClick={exportar} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">üì• CSV</button>
                  <button onClick={adicionar} className="bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700">‚ûï Nova</button>
                </div>
              </div>
              <div className="grid grid-cols-4 gap-3">
                <div className="bg-blue-50 p-3 rounded border border-blue-200">
                  <div className="text-xl font-bold text-blue-700">{stats.total}</div>
                  <div className="text-xs text-blue-600">Total</div>
                </div>
                <div className="bg-green-50 p-3 rounded border border-green-200">
                  <div className="text-xl font-bold text-green-700">{stats.ativos}</div>
                  <div className="text-xs text-green-600">Ativos</div>
                </div>
                <div className="bg-red-50 p-3 rounded border border-red-200">
                  <div className="text-xl font-bold text-red-700">{stats.vencidas}</div>
                  <div className="text-xs text-red-600">Vencidas</div>
                </div>
                <div className="bg-orange-50 p-3 rounded border border-orange-200">
                  <div className="text-xl font-bold text-orange-700">{stats.proximo}</div>
                  <div className="text-xs text-orange-600">30 dias</div>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow p-6 mb-4">
              <h2 className="font-bold mb-3">üîç Filtros</h2>
              <div className="grid grid-cols-5 gap-3 mb-3">
                <input value={busca} onChange={e => setBusca(e.target.value)} placeholder="Buscar..." className="col-span-2 px-3 py-2 border rounded" />
                <select value={filtroEstado} onChange={e => setFiltroEstado(e.target.value)} className="px-3 py-2 border rounded">
                  <option value="todos">Todos Estados</option>
                  {estados.map(e => <option key={e} value={e}>{e}</option>)}
                </select>
                <select value={filtroStatus} onChange={e => setFiltroStatus(e.target.value)} className="px-3 py-2 border rounded">
                  <option value="todos">Todos Status</option>
                  <option value="Pendente de An√°lise">‚è≥ Pendente</option>
                  <option value="Aprovado para Renova√ß√£o">‚úÖ Aprovado</option>
                  <option value="N√£o Renovar">‚ùå N√£o Renovar</option>
                  <option value="Aguardando Inser√ß√£o">‚è∞ Aguardando</option>
                  <option value="Inserido na Plataforma">üéØ Inserido</option>
                  <option value="Em Negocia√ß√£o">ü§ù Negocia√ß√£o</option>
                  <option value="Cancelado">‚õî Cancelado</option>
                  <option value="Pausado">‚è∏Ô∏è Pausado</option>
                </select>
                <select value={filtroValidade} onChange={e => setFiltroValidade(e.target.value)} className="px-3 py-2 border rounded">
                  <option value="todos">Todas Validades</option>
                  <option value="vencidas">üî¥ Vencidas</option>
                  <option value="proximo_30">üü° 30 dias</option>
                  <option value="proximo_60">üü† 31-60 dias</option>
                  <option value="acima_60">üü¢ +60 dias</option>
                  <option value="indeterminada">‚ôæÔ∏è Indeterminada</option>
                </select>
              </div>
              <div className="flex items-center gap-2">
                <label className="flex items-center gap-2 cursor-pointer bg-blue-50 px-4 py-2 rounded border border-blue-300 hover:bg-blue-100 transition">
                  <input 
                    type="checkbox" 
                    checked={ordenarAlfabetico} 
                    onChange={e => setOrdenarAlfabetico(e.target.checked)} 
                    className="w-4 h-4"
                  />
                  <span className="text-sm font-semibold text-blue-700">üî§ Ordenar Alfabeticamente</span>
                </label>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow overflow-x-auto">
              <table className="w-full border-collapse">
                <thead>
                  <tr className="bg-blue-600 text-white">
                    <th className="px-3 py-3 text-xs">‚úì</th>
                    <th className="px-3 py-3 text-xs text-left">ESCOLA</th>
                    <th className="px-3 py-3 text-xs text-left">ESTADOS</th>
                    <th className="px-3 py-3 text-xs text-left">STATUS</th>
                    <th className="px-3 py-3 text-xs text-left">PROSPEC√á√ÉO</th>
                    <th className="px-3 py-3 text-xs text-left">RENOVA√á√ÉO</th>
                    <th className="px-3 py-3 text-xs text-left">INSER√á√ÉO</th>
                    <th className="px-3 py-3 text-xs text-left">VALIDADE</th>
                    <th className="px-3 py-3 text-xs text-left">RESPONS√ÅVEL</th>
                    <th className="px-3 py-3 text-xs text-left">TELEFONE</th>
                    <th className="px-3 py-3 text-xs text-left">EMAIL</th>
                    <th className="px-3 py-3 text-xs text-left">CONTRATO</th>
                    <th className="px-3 py-3 text-xs text-left">OBS</th>
                    <th className="px-3 py-3 text-xs">A√á√ïES</th>
                  </tr>
                </thead>
                <tbody>
                  {linhasExibicao.map((l, i) => (
                    <tr key={l.id} className={`border-b ${i%2===0?'bg-white':'bg-gray-50'} ${editando===l.id?'bg-blue-50':''}`}>
                      <td className="px-3 py-2 text-center">
                        <input type="checkbox" checked={l.ativo} onChange={() => alternarAtivo(l.id, l.ativo)} className="w-4 h-4" />
                      </td>
                      <td className="px-3 py-2">
                        {editando===l.id ? <input value={temp?.escola || ''} onChange={e => setTemp({...temp, escola: e.target.value})} className="w-full px-2 py-1 border rounded" /> : <div className="cursor-pointer" onClick={() => iniciarEdicao(l)}>{l.escola || '-'}</div>}
                      </td>
                      <td className="px-3 py-2">
                        {editando===l.id ? (
                          <div className="border rounded p-2 max-h-40 overflow-y-auto">
                            {estados.map(e => <label key={e} className="flex items-center gap-1 text-xs"><input type="checkbox" checked={(temp?.estados||[]).includes(e)} onChange={() => {const est = temp?.estados||[]; setTemp({...temp, estados: est.includes(e) ? est.filter(x=>x!==e) : [...est,e]})}} />{e}</label>)}
                          </div>
                        ) : (
                          <div className="flex flex-wrap gap-1">{(l.estados||[]).map(e => <span key={e} className="bg-indigo-100 text-indigo-800 px-2 py-0.5 rounded text-xs">{e}</span>)}</div>
                        )}
                      </td>
                      <td className="px-3 py-2">
                        {editando===l.id ? (
                          <select value={temp?.status || 'Pendente de An√°lise'} onChange={e => setTemp({...temp, status: e.target.value})} className={`w-full px-2 py-1 border rounded text-xs font-bold ${statusCores[temp?.status || 'Pendente de An√°lise']}`}>
                            <option value="Pendente de An√°lise">Pendente de An√°lise</option>
                            <option value="Aprovado para Renova√ß√£o">Aprovado para Renova√ß√£o</option>
                            <option value="N√£o Renovar">N√£o Renovar</option>
                            <option value="Aguardando Inser√ß√£o">Aguardando Inser√ß√£o</option>
                            <option value="Inserido na Plataforma">Inserido na Plataforma</option>
                            <option value="Em Negocia√ß√£o">Em Negocia√ß√£o</option>
                            <option value="Cancelado">Cancelado</option>
                            <option value="Pausado">Pausado</option>
                          </select>
                        ) : (
                          <span className={`px-3 py-1 rounded-full text-xs font-bold border inline-flex items-center gap-1 ${statusCores[l.status]}`}>
                            {statusEmoji[l.status]} {l.status}
                          </span>
                        )}
                      </td>
                      <td className="px-3 py-2">{editando===l.id ? <input type="date" value={temp?.dataContato || ''} onChange={e => setTemp({...temp, dataContato: e.target.value})} className="px-2 py-1 border rounded text-xs" /> : formatarData(l.dataContato)}</td>
                      <td className="px-3 py-2">{editando===l.id ? <input type="date" value={temp?.dataRenovacao || ''} onChange={e => setTemp({...temp, dataRenovacao: e.target.value})} className="px-2 py-1 border rounded text-xs" /> : formatarData(l.dataRenovacao)}</td>
                      <td className="px-3 py-2">{editando===l.id ? <input type="date" value={temp?.dataInsercao || ''} onChange={e => setTemp({...temp, dataInsercao: e.target.value})} className="px-2 py-1 border rounded text-xs" /> : formatarData(l.dataInsercao)}</td>
                      <td className="px-3 py-2">
                        {editando===l.id ? (
                          <div>
                            <label className="flex items-center gap-1 mb-1 bg-purple-50 p-1 rounded border">
                              <input type="checkbox" checked={temp?.validadeIndeterminada || false} onChange={() => setTemp({...temp, validadeIndeterminada: !temp?.validadeIndeterminada, dataValidade: temp?.validadeIndeterminada ? temp.dataValidade : ''})} />
                              <span className="text-xs font-bold text-purple-700">‚ôæÔ∏è Indeterminada</span>
                            </label>
                            {!temp?.validadeIndeterminada && <input type="date" value={temp?.dataValidade || ''} onChange={e => setTemp({...temp, dataValidade: e.target.value})} className="w-full px-2 py-1 border rounded text-xs" />}
                          </div>
                        ) : l.validadeIndeterminada ? (
                          <span className="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-bold border border-purple-300">‚ôæÔ∏è Indeterminada</span>
                        ) : l.dataValidade ? (() => {
                          const d = calcDias(l.dataValidade);
                          let cor = 'bg-green-100 text-green-800 border-green-300', emoji = 'üü¢';
                          if (d < 0) { cor = 'bg-red-100 text-red-800 border-red-300'; emoji = 'üî¥'; }
                          else if (d <= 30) { cor = 'bg-yellow-100 text-yellow-800 border-yellow-300'; emoji = 'üü°'; }
                          else if (d <= 60) { cor = 'bg-orange-100 text-orange-800 border-orange-300'; emoji = 'üü†'; }
                          return <div><span className={`${cor} px-2 py-1 rounded-full text-xs font-bold border`}>{emoji} {formatarData(l.dataValidade)}</span><div className="text-xs text-gray-500 mt-1">{d<0?`Venceu h√° ${Math.abs(d)} dias`:`${d} dias`}</div></div>;
                        })() : '-'}
                      </td>
                      <td className="px-3 py-2">{editando===l.id ? <input value={temp?.responsavel || ''} onChange={e => setTemp({...temp, responsavel: e.target.value})} className="px-2 py-1 border rounded text-xs" /> : l.responsavel || '-'}</td>
                      <td className="px-3 py-2">{editando===l.id ? <input value={temp?.contatoResponsavel || ''} onChange={e => setTemp({...temp, contatoResponsavel: e.target.value})} className="px-2 py-1 border rounded text-xs" /> : l.contatoResponsavel || '-'}</td>
                      <td className="px-3 py-2">{editando===l.id ? <input type="email" value={temp?.emailResponsavel || ''} onChange={e => setTemp({...temp, emailResponsavel: e.target.value})} className="px-2 py-1 border rounded text-xs" /> : l.emailResponsavel ? <a href={`mailto:${l.emailResponsavel}`} className="text-blue-600 underline text-xs">{l.emailResponsavel}</a> : '-'}</td>
                      <td className="px-3 py-2">{editando===l.id ? <input type="url" value={temp?.linkContrato || ''} onChange={e => setTemp({...temp, linkContrato: e.target.value})} className="px-2 py-1 border rounded text-xs" /> : l.linkContrato ? <a href={l.linkContrato} target="_blank" className="text-blue-600 underline text-xs">üîó Contrato</a> : '-'}</td>
                      <td className="px-3 py-2">{editando===l.id ? <input value={temp?.observacoes || ''} onChange={e => setTemp({...temp, observacoes: e.target.value})} className="px-2 py-1 border rounded text-xs" /> : l.observacoes || '-'}</td>
                      <td className="px-3 py-2 text-center">
                        {editando===l.id ? (
                          <div className="flex gap-1 justify-center">
                            <button onClick={salvar} className="bg-green-600 text-white p-1 rounded text-xs">‚úì</button>
                            <button onClick={cancelarEdicao} className="bg-gray-600 text-white p-1 rounded text-xs">‚úï</button>
                          </div>
                        ) : (
                          <div className="flex gap-1 justify-center">
                            <button onClick={() => iniciarEdicao(l)} className="bg-blue-600 text-white p-1 rounded text-xs">‚úèÔ∏è</button>
                            <button onClick={() => excluir(l.id)} className="bg-red-600 text-white p-1 rounded text-xs">üóëÔ∏è</button>
                          </div>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
